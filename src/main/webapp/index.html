<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <!--   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
   -->
    <link rel="stylesheet" href="webjars/bootstrap/4.4.1/css/bootstrap.min.css">

    <!--My CSS-->
    <link rel="stylesheet" type="text/css" href="styles.css">


    <title>Hello, world!</title>
</head>
<body>


<div class="jumbotron jumbotron-fluid">
    <div class="container">
        <h1>Too busy to manage it all? Plan your week with to-do lists!</h1>
        <p>No need to remember everything anymore.</p>
    </div>
</div>

<main>

    <div id="welcome" style="text-align: center">
        <h6>Choose the date</h6>
    </div>

    <div class="container">

        <div class="row justify-content-md-center">
            <div class="col-md-4 p-2">
                <select class="custom-select" id="selectDay"></select>
            </div>

            <div class="col-md-4 p-2">
                <select class="custom-select" id="selectMonth"></select>
            </div>

            <div class="col-md-4 p-2">
                <select class="custom-select" id="selectYear"></select>
            </div>

        </div>
    </div>


    <!--    <div id="welcome" style="text-align: center">
            <h1>Introduce yourself</h1>
        </div>
        <form id="welcomeForm" class="pure-form pure-g pure-form-aligned">
            <input class="pure-input-rounded pure-u-1" name="name" placeholder="name">
            <fieldset id="langs" class="pure-u-1 pure-control-group">Loading...</fieldset>
            <button id="btn" class="pure-button pure-button-primary pure-u-1">Submit</button>
        </form>-->


    <div class="container">

        <div class="row justify-content-md-center">
            <div class="col-md-4 px-2">
                <div class="card my-2" id="monday">
                    <div class="card-body">
                        <h5 class="card-title">Monday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle1"></h6>
                        <form id="todoForm-monday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-monday"
                                       placeholder="new to-do">
                                <button class="btn btn-primary mt-1" id="addTodo-monday">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-monday" class="mt-3">
                            <!--               <div class="form-check m-1">
                                               <input class="form-check-input" type="checkbox">
                                               <label class="form-check-label">
                                                   Default checkbox 1
                                               </label>

                                           </div>

                                               <div class="form-check m-1">
                                               <input class="form-check-input" type="checkbox">
                                               <label class="form-check-label">
                                                   Default checkbox 2
                                               </label>
                                               </div>-->

                        </fieldset>
                        <div></div>

                        <!--               <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                                           card's content.</p>-->
                        <!--                        <a href="#" class="card-link">Card link</a>
                                                <a href="#" class="card-link">Another link</a>-->
                    </div>
                </div>
            </div>
            <div class="col-md-4 px-2">
                <div class="card my-2" id="tuesday">
                    <div class="card-body">
                        <h5 class="card-title">Tuesday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle2"></h6>

                        <form id="todoForm-tuesday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-tuesday"
                                       placeholder="new to-do">
                                <button class="btn btn-primary mt-1" id="addTodo-tuesday">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-tuesday" class="mt-3"></fieldset>
                    </div>
                </div>
            </div>
            <div class="col-md-4 px-2">
                <div class="card my-2" id="wednesday">
                    <div class="card-body">
                        <h5 class="card-title">Wednesday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle3"></h6>

                        <form id="todoForm-wednesday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-wednesday"
                                       placeholder="new to-do">
                                <button class="btn btn-primary mt-1" id="addTodo-wednesday">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-wednesday" class="mt-3"></fieldset>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col-md-4 px-2">
                <div class="card my-2" id="thursday">
                    <div class="card-body">
                        <h5 class="card-title">Thursday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle4"></h6>

                        <form id="todoForm-thursday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-thursday"
                                       placeholder="new to-do">
                                <button id="addTodo-thursday" class="btn btn-primary mt-1">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-thursday" class="mt-3"></fieldset>

                    </div>
                </div>
            </div>
            <div class="col-md-4 px-2">
                <div class="card my-2" id="friday">
                    <div class="card-body">
                        <h5 class="card-title">Friday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle5"></h6>

                        <form id="todoForm-friday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-friday"
                                       placeholder="new to-do">
                                <button id="addTodo-friday" class="btn btn-primary mt-1">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-friday" class="mt-3"></fieldset>

                    </div>
                </div>
            </div>
            <div class="col-md-4 px-2">
                <div class="card my-2" id="saturday">
                    <div class="card-body">
                        <h5 class="card-title">Saturday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle6"></h6>
                        <form id="todoForm-saturday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-saturday"
                                       placeholder="new to-do">
                                <button id="addTodo-saturday" class="btn btn-primary mt-1">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-saturday" class="mt-3"></fieldset>

                    </div>
                </div>

            </div>


        </div>


    </div>


    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col-md-4 px-2">
                <div class="card my-2" id="sunday">
                    <div class="card-body">
                        <h5 class="card-title">Sunday</h5>
                        <h6 class="card-subtitle mb-2 text-muted text-center" id="subtitle7"></h6>
                        <form id="todoForm-sunday" class="form-inline">
                            <div class="row justify-content-center">
                                <input type="text" class="form-control w-75 mr-1 mt-1" id="todoText-sunday"
                                       placeholder="new to-do">
                                <button id="addTodo-sunday" class="btn btn-primary mt-1">Add</button>
                            </div>
                        </form>

                        <fieldset id="allTodos-sunday" class="mt-3">


                        </fieldset>


                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript-->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="webjars/jquery/3.4.1/jquery.min.js"></script>
    <script src="webjars/popper.js/1.16.0/popper.min.js"></script>
    <script src="webjars/bootstrap/4.4.1/js/bootstrap.min.js"></script>


    <!--Prepare date selection-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <!--<script src="dateSelection.js"></script>-->

</main>

<script>


    //Create list of months
    moment.locale('pl'); // sets words language (optional if current locale is to be used)
    const arrayOfMonths = moment.months();

    const monthList = document.getElementById('selectMonth');

    arrayOfMonths.forEach(function (item, index) {
        const option = document.createElement('option');
        option.appendChild(document.createTextNode(item));
        option.value = (index).toString();
        monthList.appendChild(option);
    });


    //Create list of years from 2010 until now
    const yearList = document.getElementById('selectYear');
    first = new Date(2010, 1, 1).getFullYear();
    dateNow = new Date();
    second = dateNow.getFullYear();

    arrayOfYears = Array();

    for (let i = first; i <= second; i++) arrayOfYears.push(i);

    arrayOfYears.forEach(function (item, index) {
        const option = document.createElement('option');
        option.appendChild(document.createTextNode(item));
        option.value = (index + 1).toString();
        yearList.appendChild(option);
    });

    const selectionOfYears = document.getElementById('selectYear');
    const selectionOfMonths = document.getElementById('selectMonth');


    //Create list of days in month
    const dayList = document.getElementById('selectDay');

    let lastSelectedDay = 0;

    function daysInMonth() {

        var selectedYear = selectionOfYears.options[selectionOfYears.selectedIndex];
        var selectedMonth = selectionOfMonths.options[selectionOfMonths.selectedIndex];

        const timeZero = new Date(selectedYear.text, parseInt(selectedMonth.value) + 1, 0);
        //console.log(timeZero.getDate());

        const arrayOfDays = Array();

        for (let i = 1; i <= timeZero.getDate(); i++) arrayOfDays.push(i);

        //Delete all days from the previous month selected
        dayList.querySelectorAll('*').forEach(n => n.remove());


        arrayOfDays.forEach(function (item, index) {
            const option = document.createElement('option');
            option.appendChild(document.createTextNode(item));
            option.value = (index + 1).toString();
            dayList.appendChild(option);
        });

        dayList.selectedIndex = lastSelectedDay;

        if (dayList.selectedIndex == -1) {
            dayList.selectedIndex = dayList.childElementCount - 1;
        }

    }

    daysInMonth();
    setCurrentDate();
    fillCardsContent();

    /*    $.each($('.card-subtitle'), function () {
            let idString = this.id;
            let count = parseInt(idString.charAt(idString.length - 1)) - 1;
            let thisDate = addDays(firstDayOfWeek, count);
            let thisDate = new Date(selectedYear.text, selectedMonth.value, parseInt(selectedDay.text));
            this.innerHTML = (thisDate.getDate().toString()).concat(' ', arrayOfMonths[thisDate.getMonth()],
                ' ', thisDate.getFullYear().toString());
        });*/


    function setCurrentDate() {
        let currentDate = new Date();
        dayList.selectedIndex = currentDate.getDate();
        selectionOfMonths.selectedIndex = currentDate.getMonth();
        selectionOfYears.selectedIndex = selectionOfYears.childElementCount - 1;
    }


    var selectedDay = dayList.options[dayList.selectedIndex];
    var selectedYear = selectionOfYears.options[selectionOfYears.selectedIndex];
    var selectedMonth = selectionOfMonths.options[selectionOfMonths.selectedIndex];


    const API_URL = 'http://localhost:8080/api';
    const TODO_API_URL = `${API_URL}/todos`;


    $('#selectDay, #selectMonth, #selectYear').on('change', fillCardsContent);


    function fillCardsContent() {

        lastSelectedDay = dayList.selectedIndex;

        daysInMonth();


        document.querySelectorAll('[id^="allTodos-"]').forEach(s => $(s).empty());

        //Take note of the date that is selected and choose monday from that week
        var selectedDay = dayList.options[dayList.selectedIndex];
        var selectedYear = selectionOfYears.options[selectionOfYears.selectedIndex];
        var selectedMonth = selectionOfMonths.options[selectionOfMonths.selectedIndex];

        const chosenDay = parseInt(selectedDay.text);
        const chosenDate = new Date(selectedYear.text, selectedMonth.value, chosenDay);


        var clonedChosenDay = new Date(chosenDate.getTime());

        function addDays(date, days) {
            const copy = new Date(Number(date));
            copy.setDate(date.getDate() + days);
            return copy
        }

        let add;
        if (clonedChosenDay.getDay() == 0) {
            add = -6;
        } else {
            add = (-1) * (clonedChosenDay.getDay() - 1);
        }

        const firstDayOfWeek = addDays(clonedChosenDay, add);
        const lastDayOfWeek = addDays(new Date(firstDayOfWeek.getTime()), 6);


        $.each($('.card-subtitle'), function () {
            let idString = this.id;
            let count = parseInt(idString.charAt(idString.length - 1)) - 1;
            let thisDate = addDays(firstDayOfWeek, count);
            this.innerHTML = (thisDate.getDate().toString()).concat(' ', arrayOfMonths[thisDate.getMonth()],
                ' ', thisDate.getFullYear().toString());
            const parentCard = this.parentElement.parentElement;
            if (thisDate.getTime() === chosenDate.getTime()) {
                //$(this).parent().parent('.card').css("background-color", "palevioletred");
                parentCard.classList.add('current');
            } else {
                parentCard.classList.remove('current');
            }

        });

        const firstDayOfWeekMiliseconds = +firstDayOfWeek;

        const API_URL = 'http://localhost:8080/api';
        const TODO_API_URL = `${API_URL}/todos`;

        fetch(`${TODO_API_URL}/${firstDayOfWeekMiliseconds}`)
            .then(processOkResponse)
            .then(todos => todos.forEach(createNewTodo));


    }

    function createNewTodo(todo) {
        const divForm = document.createElement('div');
        divForm.classList.add('form-check');
        divForm.classList.add('m-1');

        const label = document.createElement('label');
        label.classList.add('form-check-label');

        const checkbox = document.createElement('input');
        checkbox.classList.add('form-check-input');

        checkbox.type = 'checkbox';
        checkbox.checked = todo.done;
        if (checkbox.checked) {
            label.classList.add('done');
        }
        checkbox.addEventListener('click',
            (event) => {
                event.preventDefault();
                fetch(`${TODO_API_URL}/${todo.id}`, {method: 'PUT'})
                    .then(processOkResponse)
                    .then(updatedTodo => checkbox.checked = !!updatedTodo.done)
                    .catch(console.warn);
                label.classList.toggle('done');
            });

        divForm.appendChild(checkbox);
        divForm.appendChild(label);
        label.appendChild(document.createTextNode(` ${todo.text}`));
        const dayOfTodo = new Date(todo.date).getDay();

        const arrayOfWeekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Satruday'];
        const nameOfDay = (arrayOfWeekDays[dayOfTodo]).toLowerCase();
        console.log(nameOfDay);
        document.getElementById('allTodos-'.concat(nameOfDay)).appendChild(divForm);

    }


    //Add new todo
    (function () {

        $.each($('.card'), function () {
            const dayOfWeek = this.id;

            const addTodoButton = document.getElementById('addTodo-'.concat(dayOfWeek));
            const todoText = document.getElementById('todoText-'.concat(dayOfWeek));
            const dateOfDayString = $(this).children().children('.card-subtitle').html().toString();
            //console.log(new Date('26 January 2014'));
            //console.log(dateOfDay);
            const dateOfDay = new Date(dateOfDayString);
            //'2019-01-01'
            let dateString = formatDate(dateOfDay);

            addTodoButton.addEventListener('click', (event) => {
                event.preventDefault();
                fetch(TODO_API_URL, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },

                    body: JSON.stringify({text: todoText.value, date: dateString})
                })
                    .then(processOkResponse)
                    .then(createNewTodo)
                    .then(() => todoText.value = '')
                    .catch(console.warn);
            });


        })
    })();

    function processOkResponse(response = {}) {
        if (response.ok) {
            return response.json();
        }
        throw new Error(`Status not 200 (${response.status})`);
    }


    function formatDate(dateToFormat) {
        var dd = dateToFormat.getDate();
        var mm = dateToFormat.getMonth() + 1;
        var yyyy = dateToFormat.getFullYear();
        if (dd < 10) {
            dd = '0' + dd;
        }

        if (mm < 10) {
            mm = '0' + mm;
        }
        return (yyyy + '-' + mm + '-' + dd);
    }



</script>
</body>
</html>





